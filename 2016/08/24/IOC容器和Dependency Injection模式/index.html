
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  
  <title>IOC容器和Dependency Injection模式 | WoodyOilove&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="In the Java community there’s been a rush of lightweight containers that help to assemble components from different projects into a cohesive application. Underlying these containers is a common patter">
<meta property="og:type" content="article">
<meta property="og:title" content="IOC容器和Dependency Injection模式">
<meta property="og:url" content="http://yoursite.com/2016/08/24/IOC容器和Dependency Injection模式/index.html">
<meta property="og:site_name" content="WoodyOilove's Blog">
<meta property="og:description" content="In the Java community there’s been a rush of lightweight containers that help to assemble components from different projects into a cohesive application. Underlying these containers is a common patter">
<meta property="og:image" content="http://img.blog.csdn.net/20160824114104958">
<meta property="og:image" content="http://img.blog.csdn.net/20160824114404212">
<meta property="og:image" content="http://img.blog.csdn.net/20160824115751107">
<meta property="og:updated_time" content="2016-08-29T10:02:30.819Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="IOC容器和Dependency Injection模式">
<meta name="twitter:description" content="In the Java community there’s been a rush of lightweight containers that help to assemble components from different projects into a cohesive application. Underlying these containers is a common patter">
<meta name="twitter:image" content="http://img.blog.csdn.net/20160824114104958">
  
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
  

</head>

<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <nav id="upper-nav" class="inner">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <div class="sub-nav">
        
        
          <a id="nav-github" class="nav-icon" href="https://github.com/oilove"></a>
        
      </div>
    </nav>
    <div id="header-title">
      
        <h1 id="blog-title-wrap">
          <a href="/" id="blog-title">WoodyOilove&#39;s Blog</a>
        </h1>
      
    </div>
    <div id="contenedor">
      <ul class="cube">
        <li class="cara">H</li>
        <li class="cara"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="100" width="100" viewBox="-50 -50 200 200">
          <circle cx="50" cy="50" r="45" stroke-width="5" stroke="black" stroke-opacity="0.5" fill-opacity="0"></circle>
          <rect x="47.5" y="27.5" width="5" height="25" rx="2.5" ry="2.5" fill="black" fill-opacity="0.5" transform="rotate(330 50 50)"></rect>
          <rect x="48.5" y="16.5" width="3" height="35" rx="1.5" ry="1.5" fill="black" fill-opacity="0.5"></rect>
        </svg></li>
        <li class="cara">F</li>
        <li class="cara">O</li>
        <li class="cara">E</li>
        <li class="cara">N</li>
      </ul>
    </div>
    <nav id="main-nav">
      
        <a class="main-nav-link" href="/">Home</a>
      
        <a class="main-nav-link" href="/archives">Archives</a>
      
        <a class="main-nav-link" href="/about">About</a>
      
      <!--<a class="main-nav-link st-search-show-outputs">Search</a>-->
    </nav>
  </div>
</header>

    <div class="outer">
      <section id="main"><article id="post-IOC容器和Dependency Injection模式" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2016/08/24/IOC容器和Dependency Injection模式/" class="article-date">
  <time datetime="2016-08-23T16:00:00.000Z" itemprop="datePublished">2016-08-24</time>
</h3>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java框架/">Java框架</a>
  </div>

  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      IOC容器和Dependency Injection模式
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
          <div id="toc" class="toc-article">
            <strong class="toc-title">文章目錄</strong>
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Components-and-Services"><span class="toc-text">Components and Services</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#A-Naive-Example"><span class="toc-text">A Naive Example</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Inversion-of-Control"><span class="toc-text">Inversion of Control</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Forms-of-Dependency-Injection"><span class="toc-text">Forms of Dependency Injection</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Constructor-Injection-with-PicoContainer"><span class="toc-text">Constructor Injection with PicoContainer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Setter-Injection-with-Spring"><span class="toc-text">Setter Injection with Spring</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Interface-Injection"><span class="toc-text">Interface Injection</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Using-a-Service-Locator"><span class="toc-text">Using a Service Locator</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-a-Segregated-Interface-for-the-Locator"><span class="toc-text">Using a Segregated Interface for the Locator</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#A-Dynamic-Service-Locator"><span class="toc-text">A Dynamic Service Locator</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Using-both-a-locator-and-injection-with-Avalon"><span class="toc-text">Using both a locator and injection with Avalon</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Deciding-which-option-to-use"><span class="toc-text">Deciding which option to use</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Service-Locator-vs-Dependency-Injection"><span class="toc-text">Service Locator vs Dependency Injection</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Constructor-versus-Setter-Injection"><span class="toc-text">Constructor versus Setter Injection</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Code-or-configuration-files"><span class="toc-text">Code or configuration files</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Separating-Configuration-from-Use"><span class="toc-text">Separating Configuration from Use</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Some-further-issues"><span class="toc-text">Some further issues</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Concluding-Thoughts"><span class="toc-text">Concluding Thoughts</span></a></li></ol>
          </div>
        
        <p>In the Java community there’s been a rush of lightweight containers that help to assemble components from different projects into a cohesive application. Underlying these containers is a common pattern to how they perform the wiring, a concept they refer under the very generic name of “Inversion of Control”. In this article I dig into how this pattern works, under the more specific name of “Dependency Injection”, and contrast it with the Service Locator alternative. The choice between them is less important than the principle of separating configuration from use.</p>
<p>One of the entertaining things about the enterprise Java world is the huge amount of activity in building alternatives to the mainstream J2EE technologies, much of it happening in open source. A lot of this is a reaction to the heavyweight complexity in the mainstream J2EE world, but much of it is also exploring alternatives and coming up with creative ideas. A common issue to deal with is how to wire together different elements: how do you fit together this web controller architecture with that database interface backing when they were built by different teams with little knowledge of each other. A number of frameworks have taken a stab at this problem, and several are branching out to provide a general capability to assemble components from different layers. These are often referred to as lightweight containers, examples include PicoContainer, and Spring.</p>
<p>Underlying these containers are a number of interesting design principles, things that go beyond both these specific containers and indeed the Java platform. Here I want to start exploring some of these principles. The examples I use are in Java, but like most of my writing the principles are equally applicable to other OO environments, particularly .NET.</p>
<a id="more"></a>
<h1 id="Components-and-Services"><a href="#Components-and-Services" class="headerlink" title="Components and Services"></a>Components and Services</h1><p>The topic of wiring elements together drags me almost immediately into the knotty terminology problems that surround the terms service and component. You find long and contradictory articles on the definition of these things with ease. For my purposes here are my current uses of these overloaded terms.</p>
<p>I use component to mean a glob of software that’s intended to be used, without change, by an application that is out of the control of the writers of the component. By ‘without change’ I mean that the using application doesn’t change the source code of the components, although they may alter the component’s behavior by extending it in ways allowed by the component writers.</p>
<p>A service is similar to a component in that it’s used by foreign applications. The main difference is that I expect a component to be used locally (think jar file, assembly, dll, or a source import). A service will be used remotely through some remote interface, either synchronous or asynchronous (eg web service, messaging system, RPC, or socket.)</p>
<p>I mostly use service in this article, but much of the same logic can be applied to local components too. Indeed often you need some kind of local component framework to easily access a remote service. But writing “component or service” is tiring to read and write, and services are much more fashionable at the moment.</p>
<h1 id="A-Naive-Example"><a href="#A-Naive-Example" class="headerlink" title="A Naive Example"></a>A Naive Example</h1><p>To help make all of this more concrete I’ll use a running example to talk about all of this. Like all of my examples it’s one of those super-simple examples; small enough to be unreal, but hopefully enough for you to visualize what’s going on without falling into the bog of a real example.</p>
<p>In this example I’m writing a component that provides a list of movies directed by a particular director. This stunningly useful function is implemented by a single method.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">class MovieLister...</div><div class="line">  public Movie[] moviesDirectedBy(String arg) &#123;</div><div class="line">      List allMovies = finder.findAll();</div><div class="line">      for (Iterator it = allMovies.iterator(); it.hasNext();) &#123;</div><div class="line">          Movie movie = (Movie) it.next();</div><div class="line">          if (!movie.getDirector().equals(arg)) it.remove();</div><div class="line">      &#125;</div><div class="line">      return (Movie[]) allMovies.toArray(new Movie[allMovies.size()]);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>The implementation of this function is naive in the extreme, it asks a finder object (which we’ll get to in a moment) to return every film it knows about. Then it just hunts through this list to return those directed by a particular director. This particular piece of naivety I’m not going to fix, since it’s just the scaffolding for the real point of this article.</p>
<p>The real point of this article is this finder object, or particularly how we connect the lister object with a particular finder object. The reason why this is interesting is that I want my wonderful moviesDirectedBy method to be completely independent of how all the movies are being stored. So all the method does is refer to a finder, and all that finder does is know how to respond to the findAll method. I can bring this out by defining an interface for the finder.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MovieFinder</span> </span>&#123;</div><div class="line">    <span class="function">List <span class="title">findAll</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Now all of this is very well decoupled, but at some point I have to come up with a concrete class to actually come up with the movies. In this case I put the code for this in the constructor of my lister class.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovieLister</span>...</span></div><div class="line">  <span class="title">private</span> <span class="title">MovieFinder</span> <span class="title">finder</span>;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MovieLister</span><span class="params">()</span> </span>&#123;</div><div class="line">    finder = <span class="keyword">new</span> ColonDelimitedMovieFinder(<span class="string">"movies1.txt"</span>);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>The name of the implementation class comes from the fact that I’m getting my list from a colon delimited text file. I’ll spare you the details, after all the point is just that there’s some implementation.</p>
<p>Now if I’m using this class for just myself, this is all fine and dandy. But what happens when my friends are overwhelmed by a desire for this wonderful functionality and would like a copy of my program? If they also store their movie listings in a colon delimited text file called “movies1.txt” then everything is wonderful. If they have a different name for their movies file, then it’s easy to put the name of the file in a properties file. But what if they have a completely different form of storing their movie listing: a SQL database, an XML file, a web service, or just another format of text file? In this case we need a different class to grab that data. Now because I’ve defined a MovieFinder interface, this won’t alter my moviesDirectedBy method. But I still need to have some way to get an instance of the right finder implementation into place.</p>
<p><img src="http://img.blog.csdn.net/20160824114104958" alt="Figure1"><br><em>Figure 1: The dependencies using a simple creation in the lister class</em></p>
<p>Figure 1 shows the dependencies for this situation. The MovieLister class is dependent on both the MovieFinder interface and upon the implementation. We would prefer it if it were only dependent on the interface, but then how do we make an instance to work with?</p>
<p>In my book P of EAA, we described this situation as a Plugin. The implementation class for the finder isn’t linked into the program at compile time, since I don’t know what my friends are going to use. Instead we want my lister to work with any implementation, and for that implementation to be plugged in at some later point, out of my hands. The problem is how can I make that link so that my lister class is ignorant of the implementation class, but can still talk to an instance to do its work.</p>
<p>Expanding this into a real system, we might have dozens of such services and components. In each case we can abstract our use of these components by talking to them through an interface (and using an adapter if the component isn’t designed with an interface in mind). But if we wish to deploy this system in different ways, we need to use plugins to handle the interaction with these services so we can use different implementations in different deployments.</p>
<p>So the core problem is how do we assemble these plugins into an application? This is one of the main problems that this new breed of lightweight containers face, and universally they all do it using Inversion of Control.</p>
<h1 id="Inversion-of-Control"><a href="#Inversion-of-Control" class="headerlink" title="Inversion of Control"></a>Inversion of Control</h1><p>When these containers talk about how they are so useful because they implement “Inversion of Control” I end up very puzzled. Inversion of control is a common characteristic of frameworks, so saying that these lightweight containers are special because they use inversion of control is like saying my car is special because it has wheels.</p>
<p>The question is: “what aspect of control are they inverting?” When I first ran into inversion of control, it was in the main control of a user interface. Early user interfaces were controlled by the application program. You would have a sequence of commands like “Enter name”, “enter address”; your program would drive the prompts and pick up a response to each one. With graphical (or even screen based) UIs the UI framework would contain this main loop and your program instead provided event handlers for the various fields on the screen. The main control of the program was inverted, moved away from you to the framework.</p>
<p>For this new breed of containers the inversion is about how they lookup a plugin implementation. In my naive example the lister looked up the finder implementation by directly instantiating it. This stops the finder from being a plugin. The approach that these containers use is to ensure that any user of a plugin follows some convention that allows a separate assembler module to inject the implementation into the lister.</p>
<p>As a result I think we need a more specific name for this pattern. Inversion of Control is too generic a term, and thus people find it confusing. As a result with a lot of discussion with various IoC advocates we settled on the name Dependency Injection.</p>
<p>I’m going to start by talking about the various forms of dependency injection, but I’ll point out now that that’s not the only way of removing the dependency from the application class to the plugin implementation. The other pattern you can use to do this is Service Locator, and I’ll discuss that after I’m done with explaining Dependency Injection.</p>
<h1 id="Forms-of-Dependency-Injection"><a href="#Forms-of-Dependency-Injection" class="headerlink" title="Forms of Dependency Injection"></a>Forms of Dependency Injection</h1><p>The basic idea of the Dependency Injection is to have a separate object, an assembler, that populates a field in the lister class with an appropriate implementation for the finder interface, resulting in a dependency diagram along the lines of Figure 2</p>
<p><img src="http://img.blog.csdn.net/20160824114404212" alt="Figure2"><br><em>Figure 2: The dependencies for a Dependency Injector</em></p>
<p>There are three main styles of dependency injection. The names I’m using for them are Constructor Injection, Setter Injection, and Interface Injection. If you read about this stuff in the current discussions about Inversion of Control you’ll hear these referred to as type 1 IoC (interface injection), type 2 IoC (setter injection) and type 3 IoC (constructor injection). I find numeric names rather hard to remember, which is why I’ve used the names I have here.</p>
<h2 id="Constructor-Injection-with-PicoContainer"><a href="#Constructor-Injection-with-PicoContainer" class="headerlink" title="Constructor Injection with PicoContainer"></a>Constructor Injection with PicoContainer</h2><p>I’ll start with showing how this injection is done using a lightweight container called <a href="http://picocontainer.com/" target="_blank" rel="external">PicoContainer</a>. I’m starting here primarily because several of my colleagues at ThoughtWorks are very active in the development of PicoContainer (yes, it’s a sort of corporate nepotism.)</p>
<p>PicoContainer uses a constructor to decide how to inject a finder implementation into the lister class. For this to work, the movie lister class needs to declare a constructor that includes everything it needs injected.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovieLister</span>...</span></div><div class="line">  <span class="title">public</span> <span class="title">MovieLister</span>(<span class="title">MovieFinder</span> <span class="title">finder</span>) &#123;</div><div class="line">      <span class="keyword">this</span>.finder = finder;       </div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>The finder itself will also be managed by the pico container, and as such will have the filename of the text file injected into it by the container.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ColonMovieFinder</span>...</span></div><div class="line">  <span class="title">public</span> <span class="title">ColonMovieFinder</span>(<span class="title">String</span> <span class="title">filename</span>) &#123;</div><div class="line">      <span class="keyword">this</span>.filename = filename;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>The pico container then needs to be told which implementation class to associate with each interface, and which string to inject into the finder.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> MutablePicoContainer <span class="title">configureContainer</span><span class="params">()</span> </span>&#123;</div><div class="line">    MutablePicoContainer pico = <span class="keyword">new</span> DefaultPicoContainer();</div><div class="line">    Parameter[] finderParams =  &#123;<span class="keyword">new</span> ConstantParameter(<span class="string">"movies1.txt"</span>)&#125;;</div><div class="line">    pico.registerComponentImplementation(MovieFinder.class, ColonMovieFinder.class, finderParams);</div><div class="line">    pico.registerComponentImplementation(MovieLister.class);</div><div class="line">    <span class="keyword">return</span> pico;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>This configuration code is typically set up in a different class. For our example, each friend who uses my lister might write the appropriate configuration code in some setup class of their own. Of course it’s common to hold this kind of configuration information in separate config files. You can write a class to read a config file and set up the container appropriately. Although PicoContainer doesn’t contain this functionality itself, there is a closely related project called NanoContainer that provides the appropriate wrappers to allow you to have XML configuration files. Such a nano container will parse the XML and then configure an underlying pico container. The philosophy of the project is to separate the config file format from the underlying mechanism.</p>
<p>To use the container you write code something like this.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWithPico</span><span class="params">()</span> </span>&#123;</div><div class="line">    MutablePicoContainer pico = configureContainer();</div><div class="line">    MovieLister lister = (MovieLister) pico.getComponentInstance(MovieLister.class);</div><div class="line">    Movie[] movies = lister.moviesDirectedBy(<span class="string">"Sergio Leone"</span>);</div><div class="line">    assertEquals(<span class="string">"Once Upon a Time in the West"</span>, movies[<span class="number">0</span>].getTitle());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Although in this example I’ve used constructor injection, PicoContainer also supports setter injection, although its developers do prefer constructor injection.</p>
<h2 id="Setter-Injection-with-Spring"><a href="#Setter-Injection-with-Spring" class="headerlink" title="Setter Injection with Spring"></a>Setter Injection with Spring</h2><p>The Spring framework is a wide ranging framework for enterprise Java development. It includes abstraction layers for transactions, persistence frameworks, web application development and JDBC. Like PicoContainer it supports both constructor and setter injection, but its developers tend to prefer setter injection - which makes it an appropriate choice for this example.</p>
<p>To get my movie lister to accept the injection I define a setting method for that service<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovieLister</span>...</span></div><div class="line">  <span class="title">private</span> <span class="title">MovieFinder</span> <span class="title">finder</span>;</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFinder</span><span class="params">(MovieFinder finder)</span> </span>&#123;</div><div class="line">  <span class="keyword">this</span>.finder = finder;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Similarly I define a setter for the filename.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ColonMovieFinder</span>...</span></div><div class="line">  <span class="title">public</span> <span class="title">void</span> <span class="title">setFilename</span>(<span class="title">String</span> <span class="title">filename</span>) &#123;</div><div class="line">      <span class="keyword">this</span>.filename = filename;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>The third step is to set up the configuration for the files. Spring supports configuration through XML files and also through code, but XML is the expected way to do it.<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"MovieLister"</span> <span class="attr">class</span>=<span class="string">"spring.MovieLister"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"finder"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">local</span>=<span class="string">"MovieFinder"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"MovieFinder"</span> <span class="attr">class</span>=<span class="string">"spring.ColonMovieFinder"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"filename"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>movies1.txt<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>The test then looks like this.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testWithSpring</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    ApplicationContext ctx = <span class="keyword">new</span> FileSystemXmlApplicationContext(<span class="string">"spring.xml"</span>);</div><div class="line">    MovieLister lister = (MovieLister) ctx.getBean(<span class="string">"MovieLister"</span>);</div><div class="line">    Movie[] movies = lister.moviesDirectedBy(<span class="string">"Sergio Leone"</span>);</div><div class="line">    assertEquals(<span class="string">"Once Upon a Time in the West"</span>, movies[<span class="number">0</span>].getTitle());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="Interface-Injection"><a href="#Interface-Injection" class="headerlink" title="Interface Injection"></a>Interface Injection</h2><p>The third injection technique is to define and use interfaces for the injection. Avalon is an example of a framework that uses this technique in places. I’ll talk a bit more about that later, but in this case I’m going to use it with some simple sample code.</p>
<p>With this technique I begin by defining an interface that I’ll use to perform the injection through. Here’s the interface for injecting a movie finder into an object.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InjectFinder</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">injectFinder</span><span class="params">(MovieFinder finder)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>This interface would be defined by whoever provides the MovieFinder interface. It needs to be implemented by any class that wants to use a finder, such as the lister.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovieLister</span> <span class="keyword">implements</span> <span class="title">InjectFinder</span></span></div><div class="line">  <span class="title">public</span> <span class="title">void</span> <span class="title">injectFinder</span>(<span class="title">MovieFinder</span> <span class="title">finder</span>) &#123;</div><div class="line">      <span class="keyword">this</span>.finder = finder;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>I use a similar approach to inject the filename into the finder implementation.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">InjectFinderFilename</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">injectFilename</span> <span class="params">(String filename)</span></span>;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ColonMovieFinder</span> <span class="keyword">implements</span> <span class="title">MovieFinder</span>, <span class="title">InjectFinderFilename</span>...</span></div><div class="line">  <span class="title">public</span> <span class="title">void</span> <span class="title">injectFilename</span>(<span class="title">String</span> <span class="title">filename</span>) &#123;</div><div class="line">      <span class="keyword">this</span>.filename = filename;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>Then, as usual, I need some configuration code to wire up the implementations. For simplicity’s sake I’ll do it in code.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tester</span>...</span></div><div class="line">  <span class="title">private</span> <span class="title">Container</span> <span class="title">container</span>;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureContainer</span><span class="params">()</span> </span>&#123;</div><div class="line">     container = <span class="keyword">new</span> Container();</div><div class="line">     registerComponents();</div><div class="line">     registerInjectors();</div><div class="line">     container.start();</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>This configuration has two stages, registering components through lookup keys is pretty similar to the other examples.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tester</span>...</span></div><div class="line">  <span class="title">private</span> <span class="title">void</span> <span class="title">registerComponents</span>() &#123;</div><div class="line">    container.registerComponent(<span class="string">"MovieLister"</span>, MovieLister.class);</div><div class="line">    container.registerComponent(<span class="string">"MovieFinder"</span>, ColonMovieFinder.class);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>A new step is to register the injectors that will inject the dependent components. Each injection interface needs some code to inject the dependent object. Here I do this by registering injector objects with the container. Each injector object implements the injector interface.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tester</span>...</span></div><div class="line">  <span class="title">private</span> <span class="title">void</span> <span class="title">registerInjectors</span>() &#123;</div><div class="line">    container.registerInjector(InjectFinder.class, container.lookup(<span class="string">"MovieFinder"</span>));</div><div class="line">    container.registerInjector(InjectFinderFilename.class, <span class="keyword">new</span> FinderFilenameInjector());</div><div class="line">  &#125;</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Injector</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Object target)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>When the dependent is a class written for this container, it makes sense for the component to implement the injector interface itself, as I do here with the movie finder. For generic classes, such as the string, I use an inner class within the configuration code.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ColonMovieFinder</span> <span class="keyword">implements</span> <span class="title">Injector</span>...</span></div><div class="line">  <span class="title">public</span> <span class="title">void</span> <span class="title">inject</span>(<span class="title">Object</span> <span class="title">target</span>) &#123;</div><div class="line">    ((InjectFinder) target).injectFinder(<span class="keyword">this</span>);        </div><div class="line">  &#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tester</span>...</span></div><div class="line">  <span class="title">public</span> <span class="title">static</span> <span class="title">class</span> <span class="title">FinderFilenameInjector</span> <span class="keyword">implements</span> <span class="title">Injector</span> &#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inject</span><span class="params">(Object target)</span> </span>&#123;</div><div class="line">      ((InjectFinderFilename)target).injectFilename(<span class="string">"movies1.txt"</span>);      </div><div class="line">    &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>The tests then use the container.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">IfaceTester</span>...</span></div><div class="line">  <span class="title">public</span> <span class="title">void</span> <span class="title">testIface</span>() &#123;</div><div class="line">    configureContainer();</div><div class="line">    MovieLister lister = (MovieLister)container.lookup(<span class="string">"MovieLister"</span>);</div><div class="line">    Movie[] movies = lister.moviesDirectedBy(<span class="string">"Sergio Leone"</span>);</div><div class="line">    assertEquals(<span class="string">"Once Upon a Time in the West"</span>, movies[<span class="number">0</span>].getTitle());</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>The container uses the declared injection interfaces to figure out the dependencies and the injectors to inject the correct dependents. (The specific container implementation I did here isn’t important to the technique, and I won’t show it because you’d only laugh.)</p>
<h1 id="Using-a-Service-Locator"><a href="#Using-a-Service-Locator" class="headerlink" title="Using a Service Locator"></a>Using a Service Locator</h1><p>The key benefit of a Dependency Injector is that it removes the dependency that the MovieLister class has on the concrete MovieFinder implementation. This allows me to give listers to friends and for them to plug in a suitable implementation for their own environment. Injection isn’t the only way to break this dependency, another is to use a service locator.</p>
<p>The basic idea behind a service locator is to have an object that knows how to get hold of all of the services that an application might need. So a service locator for this application would have a method that returns a movie finder when one is needed. Of course this just shifts the burden a tad, we still have to get the locator into the lister, resulting in the dependencies of Figure 3</p>
<p><img src="http://img.blog.csdn.net/20160824115751107" alt="Figure3"><br><em>Figure 3: The dependencies for a Service Locator</em></p>
<p>In this case I’ll use the ServiceLocator as a singleton Registry. The lister can then use that to get the finder when it’s instantiated.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovieLister</span>...</span></div><div class="line">  <span class="title">MovieFinder</span> <span class="title">finder</span> = ServiceLocator.movieFinder();</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceLocator</span>...</span></div><div class="line">  <span class="title">public</span> <span class="title">static</span> <span class="title">MovieFinder</span> <span class="title">movieFinder</span>() &#123;</div><div class="line">      <span class="keyword">return</span> soleInstance.movieFinder;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">private</span> <span class="keyword">static</span> ServiceLocator soleInstance;</div><div class="line">  <span class="keyword">private</span> MovieFinder movieFinder;</div></pre></td></tr></table></figure></p>
<p>As with the injection approach, we have to configure the service locator. Here I’m doing it in code, but it’s not hard to use a mechanism that would read the appropriate data from a configuration file.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tester</span>...</span></div><div class="line">  <span class="title">private</span> <span class="title">void</span> <span class="title">configure</span>() &#123;</div><div class="line">      ServiceLocator.load(<span class="keyword">new</span> ServiceLocator(<span class="keyword">new</span> ColonMovieFinder(<span class="string">"movies1.txt"</span>)));</div><div class="line">  &#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceLocator</span>...</span></div><div class="line">  <span class="title">public</span> <span class="title">static</span> <span class="title">void</span> <span class="title">load</span>(<span class="title">ServiceLocator</span> <span class="title">arg</span>) &#123;</div><div class="line">      soleInstance = arg;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ServiceLocator</span><span class="params">(MovieFinder movieFinder)</span> </span>&#123;</div><div class="line">      <span class="keyword">this</span>.movieFinder = movieFinder;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>Here’s the test code.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tester</span>...</span></div><div class="line">  <span class="title">public</span> <span class="title">void</span> <span class="title">testSimple</span>() &#123;</div><div class="line">      configure();</div><div class="line">      MovieLister lister = <span class="keyword">new</span> MovieLister();</div><div class="line">      Movie[] movies = lister.moviesDirectedBy(<span class="string">"Sergio Leone"</span>);</div><div class="line">      assertEquals(<span class="string">"Once Upon a Time in the West"</span>, movies[<span class="number">0</span>].getTitle());</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>I’ve often heard the complaint that these kinds of service locators are a bad thing because they aren’t testable because you can’t substitute implementations for them. Certainly you can design them badly to get into this kind of trouble, but you don’t have to. In this case the service locator instance is just a simple data holder. I can easily create the locator with test implementations of my services.</p>
<p>For a more sophisticated locator I can subclass service locator and pass that subclass into the registry’s class variable. I can change the static methods to call a method on the instance rather than accessing instance variables directly. I can provide thread–specific locators by using thread–specific storage. All of this can be done without changing clients of service locator.</p>
<p>A way to think of this is that service locator is a registry not a singleton. A singleton provides a simple way of implementing a registry, but that implementation decision is easily changed.</p>
<h2 id="Using-a-Segregated-Interface-for-the-Locator"><a href="#Using-a-Segregated-Interface-for-the-Locator" class="headerlink" title="Using a Segregated Interface for the Locator"></a>Using a Segregated Interface for the Locator</h2><p>One of the issues with the simple approach above, is that the MovieLister is dependent on the full service locator class, even though it only uses one service. We can reduce this by using a role interface. That way, instead of using the full service locator interface, the lister can declare just the bit of interface it needs.</p>
<p>In this situation the provider of the lister would also provide a locator interface which it needs to get hold of the finder.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MovieFinderLocator</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> MovieFinder <span class="title">movieFinder</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure></p>
<p>The locator then needs to implement this interface to provide access to a finder.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">MovieFinderLocator locator = ServiceLocator.locator();</div><div class="line">MovieFinder finder = locator.movieFinder();</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ServiceLocator <span class="title">locator</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> soleInstance;</div><div class="line"> &#125;</div><div class="line"> <span class="function"><span class="keyword">public</span> MovieFinder <span class="title">movieFinder</span><span class="params">()</span> </span>&#123;</div><div class="line">     <span class="keyword">return</span> movieFinder;</div><div class="line"> &#125;</div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> ServiceLocator soleInstance;</div><div class="line"> <span class="keyword">private</span> MovieFinder movieFinder;</div></pre></td></tr></table></figure></p>
<p>You’ll notice that since we want to use an interface, we can’t just access the services through static methods any more. We have to use the class to get a locator instance and then use that to get what we need.</p>
<h2 id="A-Dynamic-Service-Locator"><a href="#A-Dynamic-Service-Locator" class="headerlink" title="A Dynamic Service Locator"></a>A Dynamic Service Locator</h2><p>The above example was static, in that the service locator class has methods for each of the services that you need. This isn’t the only way of doing it, you can also make a dynamic service locator that allows you to stash any service you need into it and make your choices at runtime.</p>
<p>In this case, the service locator uses a map instead of fields for each of the services, and provides generic methods to get and load services.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceLocator</span>...</span></div><div class="line">  <span class="title">private</span> <span class="title">static</span> <span class="title">ServiceLocator</span> <span class="title">soleInstance</span>;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">(ServiceLocator arg)</span> </span>&#123;</div><div class="line">      soleInstance = arg;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">private</span> Map services = <span class="keyword">new</span> HashMap();</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getService</span><span class="params">(String key)</span></span>&#123;</div><div class="line">      <span class="keyword">return</span> soleInstance.services.get(key);</div><div class="line">  &#125;</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadService</span> <span class="params">(String key, Object service)</span> </span>&#123;</div><div class="line">      services.put(key, service);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>Configuring involves loading a service with an appropriate key.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tester</span>...</span></div><div class="line">  <span class="title">private</span> <span class="title">void</span> <span class="title">configure</span>() &#123;</div><div class="line">      ServiceLocator locator = <span class="keyword">new</span> ServiceLocator();</div><div class="line">      locator.loadService(<span class="string">"MovieFinder"</span>, <span class="keyword">new</span> ColonMovieFinder(<span class="string">"movies1.txt"</span>));</div><div class="line">      ServiceLocator.load(locator);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>I use the service by using the same key string.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MovieLister</span>...</span></div><div class="line">  <span class="title">MovieFinder</span> <span class="title">finder</span> = (MovieFinder) ServiceLocator.getService(<span class="string">"MovieFinder"</span>);</div></pre></td></tr></table></figure></p>
<p>On the whole I dislike this approach. Although it’s certainly flexible, it’s not very explicit. The only way I can find out how to reach a service is through textual keys. I prefer explicit methods because it’s easier to find where they are by looking at the interface definitions.</p>
<h2 id="Using-both-a-locator-and-injection-with-Avalon"><a href="#Using-both-a-locator-and-injection-with-Avalon" class="headerlink" title="Using both a locator and injection with Avalon"></a>Using both a locator and injection with Avalon</h2><p>Dependency injection and a service locator aren’t necessarily mutually exclusive concepts. A good example of using both together is the Avalon framework. Avalon uses a service locator, but uses injection to tell components where to find the locator.</p>
<p>Berin Loritsch sent me this simple version of my running example using Avalon.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMovieLister</span> <span class="keyword">implements</span> <span class="title">MovieLister</span>, <span class="title">Serviceable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> MovieFinder finder;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">( ServiceManager manager )</span> <span class="keyword">throws</span> ServiceException </span>&#123;</div><div class="line">        finder = (MovieFinder)manager.lookup(<span class="string">"finder"</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>The service method is an example of interface injection, allowing the container to inject a service manager into MyMovieLister. The service manager is an example of a service locator. In this example the lister doesn’t store the manager in a field, instead it immediately uses it to lookup the finder, which it does store.</p>
<h1 id="Deciding-which-option-to-use"><a href="#Deciding-which-option-to-use" class="headerlink" title="Deciding which option to use"></a>Deciding which option to use</h1><p>So far I’ve concentrated on explaining how I see these patterns and their variations. Now I can start talking about their pros and cons to help figure out which ones to use and when.</p>
<h2 id="Service-Locator-vs-Dependency-Injection"><a href="#Service-Locator-vs-Dependency-Injection" class="headerlink" title="Service Locator vs Dependency Injection"></a>Service Locator vs Dependency Injection</h2><p>The fundamental choice is between Service Locator and Dependency Injection. The first point is that both implementations provide the fundamental decoupling that’s missing in the naive example - in both cases application code is independent of the concrete implementation of the service interface. The important difference between the two patterns is about how that implementation is provided to the application class. With service locator the application class asks for it explicitly by a message to the locator. With injection there is no explicit request, the service appears in the application class - hence the inversion of control.</p>
<p>Inversion of control is a common feature of frameworks, but it’s something that comes at a price. It tends to be hard to understand and leads to problems when you are trying to debug. So on the whole I prefer to avoid it unless I need it. This isn’t to say it’s a bad thing, just that I think it needs to justify itself over the more straightforward alternative.</p>
<p>The key difference is that with a Service Locator every user of a service has a dependency to the locator. The locator can hide dependencies to other implementations, but you do need to see the locator. So the decision between locator and injector depends on whether that dependency is a problem.</p>
<p>Using dependency injection can help make it easier to see what the component dependencies are. With dependency injector you can just look at the injection mechanism, such as the constructor, and see the dependencies. With the service locator you have to search the source code for calls to the locator. Modern IDEs with a find references feature make this easier, but it’s still not as easy as looking at the constructor or setting methods.</p>
<p>A lot of this depends on the nature of the user of the service. If you are building an application with various classes that use a service, then a dependency from the application classes to the locator isn’t a big deal. In my example of giving a Movie Lister to my friends, then using a service locator works quite well. All they need to do is to configure the locator to hook in the right service implementations, either through some configuration code or through a configuration file. In this kind of scenario I don’t see the injector’s inversion as providing anything compelling.</p>
<p>The difference comes if the lister is a component that I’m providing to an application that other people are writing. In this case I don’t know much about the APIs of the service locators that my customers are going to use. Each customer might have their own incompatible service locators. I can get around some of this by using the segregated interface. Each customer can write an adapter that matches my interface to their locator, but in any case I still need to see the first locator to lookup my specific interface. And once the adapter appears then the simplicity of the direct connection to a locator is beginning to slip.</p>
<p>Since with an injector you don’t have a dependency from a component to the injector, the component cannot obtain further services from the injector once it’s been configured.</p>
<p>A common reason people give for preferring dependency injection is that it makes testing easier. The point here is that to do testing, you need to easily replace real service implementations with stubs or mocks. However there is really no difference here between dependency injection and service locator: both are very amenable to stubbing. I suspect this observation comes from projects where people don’t make the effort to ensure that their service locator can be easily substituted. This is where continual testing helps, if you can’t easily stub services for testing, then this implies a serious problem with your design.</p>
<p>Of course the testing problem is exacerbated by component environments that are very intrusive, such as Java’s EJB framework. My view is that these kinds of frameworks should minimize their impact upon application code, and particularly should not do things that slow down the edit-execute cycle. Using plugins to substitute heavyweight components does a lot to help this process, which is vital for practices such as Test Driven Development.</p>
<p>So the primary issue is for people who are writing code that expects to be used in applications outside of the control of the writer. In these cases even a minimal assumption about a Service Locator is a problem.</p>
<h2 id="Constructor-versus-Setter-Injection"><a href="#Constructor-versus-Setter-Injection" class="headerlink" title="Constructor versus Setter Injection"></a>Constructor versus Setter Injection</h2><p>For service combination, you always have to have some convention in order to wire things together. The advantage of injection is primarily that it requires very simple conventions - at least for the constructor and setter injections. You don’t have to do anything odd in your component and it’s fairly straightforward for an injector to get everything configured.</p>
<p>Interface injection is more invasive since you have to write a lot of interfaces to get things all sorted out. For a small set of interfaces required by the container, such as in Avalon’s approach, this isn’t too bad. But it’s a lot of work for assembling components and dependencies, which is why the current crop of lightweight containers go with setter and constructor injection.</p>
<p>The choice between setter and constructor injection is interesting as it mirrors a more general issue with object-oriented programming - should you fill fields in a constructor or with setters.</p>
<p>My long running default with objects is as much as possible, to create valid objects at construction time. This advice goes back to Kent Beck’s Smalltalk Best Practice Patterns: Constructor Method and Constructor Parameter Method. Constructors with parameters give you a clear statement of what it means to create a valid object in an obvious place. If there’s more than one way to do it, create multiple constructors that show the different combinations.</p>
<p>Another advantage with constructor initialization is that it allows you to clearly hide any fields that are immutable by simply not providing a setter. I think this is important - if something shouldn’t change then the lack of a setter communicates this very well. If you use setters for initialization, then this can become a pain. (Indeed in these situations I prefer to avoid the usual setting convention, I’d prefer a method like initFoo, to stress that it’s something you should only do at birth.)</p>
<p>But with any situation there are exceptions. If you have a lot of constructor parameters things can look messy, particularly in languages without keyword parameters. It’s true that a long constructor is often a sign of an over-busy object that should be split, but there are cases when that’s what you need.</p>
<p>If you have multiple ways to construct a valid object, it can be hard to show this through constructors, since constructors can only vary on the number and type of parameters. This is when Factory Methods come into play, these can use a combination of private constructors and setters to implement their work. The problem with classic Factory Methods for components assembly is that they are usually seen as static methods, and you can’t have those on interfaces. You can make a factory class, but then that just becomes another service instance. A factory service is often a good tactic, but you still have to instantiate the factory using one of the techniques here.</p>
<p>Constructors also suffer if you have simple parameters such as strings. With setter injection you can give each setter a name to indicate what the string is supposed to do. With constructors you are just relying on the position, which is harder to follow.</p>
<p>If you have multiple constructors and inheritance, then things can get particularly awkward. In order to initialize everything you have to provide constructors to forward to each superclass constructor, while also adding you own arguments. This can lead to an even bigger explosion of constructors.</p>
<p>Despite the disadvantages my preference is to start with constructor injection, but be ready to switch to setter injection as soon as the problems I’ve outlined above start to become a problem.</p>
<p>This issue has led to a lot of debate between the various teams who provide dependency injectors as part of their frameworks. However it seems that most people who build these frameworks have realized that it’s important to support both mechanisms, even if there’s a preference for one of them.</p>
<h2 id="Code-or-configuration-files"><a href="#Code-or-configuration-files" class="headerlink" title="Code or configuration files"></a>Code or configuration files</h2><p>A separate but often conflated issue is whether to use configuration files or code on an API to wire up services. For most applications that are likely to be deployed in many places, a separate configuration file usually makes most sense. Almost all the time this will be an XML file, and this makes sense. However there are cases where it’s easier to use program code to do the assembly. One case is where you have a simple application that’s not got a lot of deployment variation. In this case a bit of code can be clearer than a separate XML file.</p>
<p>A contrasting case is where the assembly is quite complex, involving conditional steps. Once you start getting close to programming language then XML starts breaking down and it’s better to use a real language that has all the syntax to write a clear program. You then write a builder class that does the assembly. If you have distinct builder scenarios you can provide several builder classes and use a simple configuration file to select between them.</p>
<p>I often think that people are over-eager to define configuration files. Often a programming language makes a straightforward and powerful configuration mechanism. Modern languages can easily compile small assemblers that can be used to assemble plugins for larger systems. If compilation is a pain, then there are scripting languages that can work well also.</p>
<p>It’s often said that configuration files shouldn’t use a programing language because they need to be edited by non-programmers. But how often is this the case? Do people really expect non-programmers to alter the transaction isolation levels of a complex server-side application? Non-language configuration files work well only to the extent they are simple. If they become complex then it’s time to think about using a proper programming language.</p>
<p>One thing we’re seeing in the Java world at the moment is a cacophony of configuration files, where every component has its own configuration files which are different to everyone else’s. If you use a dozen of these components, you can easily end up with a dozen configuration files to keep in sync.</p>
<p>My advice here is to always provide a way to do all configuration easily with a programmatic interface, and then treat a separate configuration file as an optional feature. You can easily build configuration file handling to use the programmatic interface. If you are writing a component you then leave it up to your user whether to use the programmatic interface, your configuration file format, or to write their own custom configuration file format and tie it into the programmatic interface</p>
<h2 id="Separating-Configuration-from-Use"><a href="#Separating-Configuration-from-Use" class="headerlink" title="Separating Configuration from Use"></a>Separating Configuration from Use</h2><p>The important issue in all of this is to ensure that the configuration of services is separated from their use. Indeed this is a fundamental design principle that sits with the separation of interfaces from implementation. It’s something we see within an object-oriented program when conditional logic decides which class to instantiate, and then future evaluations of that conditional are done through polymorphism rather than through duplicated conditional code.</p>
<p>If this separation is useful within a single code base, it’s especially vital when you’re using foreign elements such as components and services. The first question is whether you wish to defer the choice of implementation class to particular deployments. If so you need to use some implementation of plugin. Once you are using plugins then it’s essential that the assembly of the plugins is done separately from the rest of the application so that you can substitute different configurations easily for different deployments. How you achieve this is secondary. This configuration mechanism can either configure a service locator, or use injection to configure objects directly.</p>
<h1 id="Some-further-issues"><a href="#Some-further-issues" class="headerlink" title="Some further issues"></a>Some further issues</h1><p>In this article, I’ve concentrated on the basic issues of service configuration using Dependency Injection and Service Locator. There are some more topics that play into this which also deserve attention, but I haven’t had time yet to dig into. In particular there is the issue of life-cycle behavior. Some components have distinct life-cycle events: stop and starts for instance. Another issue is the growing interest in using aspect oriented ideas with these containers. Although I haven’t considered this material in the article at the moment, I do hope to write more about this either by extending this article or by writing another.</p>
<p>You can find out a lot more about these ideas by looking at the web sites devoted to the lightweight containers. Surfing from the picocontainer and spring web sites will lead to you into much more discussion of these issues and a start on some of the further issues.</p>
<h1 id="Concluding-Thoughts"><a href="#Concluding-Thoughts" class="headerlink" title="Concluding Thoughts"></a>Concluding Thoughts</h1><p>The current rush of lightweight containers all have a common underlying pattern to how they do service assembly - the dependency injector pattern. Dependency Injection is a useful alternative to Service Locator. When building application classes the two are roughly equivalent, but I think Service Locator has a slight edge due to its more straightforward behavior. However if you are building classes to be used in multiple applications then Dependency Injection is a better choice.</p>
<p>If you use Dependency Injection there are a number of styles to choose between. I would suggest you follow constructor injection unless you run into one of the specific problems with that approach, in which case switch to setter injection. If you are choosing to build or obtain a container, look for one that supports both constructor and setter injection.</p>
<p>The choice between Service Locator and Dependency Injection is less important than the principle of separating service configuration from the use of services within an application.</p>
<p><em>本文转载自 <a href="http://martinfowler.com/articles/injection.html" target="_blank" rel="external">Inversion of Control Containers and the Dependency Injection pattern</a></em></p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
        <a data-url="http://yoursite.com/2016/08/24/IOC容器和Dependency Injection模式/" data-id="cisfxh8xf0000xwor3lb6z1fk" class="article-share-link">分享到</a>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/08/27/eclipse&Myeclipse&Intellij Idea源码阅读快捷键/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">
        
          eclipse&amp;Myeclipse&amp;Intellij Idea源码阅读快捷键
        
      </div>
    </a>
  
  
</nav>

  
</article>


</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/08/27/eclipse&Myeclipse&Intellij Idea源码阅读快捷键/">eclipse&amp;Myeclipse&amp;Intellij Idea源码阅读快捷键</a>
          </li>
        
          <li>
            <a href="/2016/08/24/IOC容器和Dependency Injection模式/">IOC容器和Dependency Injection模式</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分類</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java框架/">Java框架</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/开发工具/">开发工具</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">歸檔</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 WoodyOilove<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/sun11/hexo-theme-paperbox" target="_blank">Paperbox</a>
    </div>
  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
  <a href="#search" class="mobile-nav-link st-search-show-outputs">Search</a>
</nav>
  

<!-- totop start -->
<div id="totop">
	<a title="返回頂部"></a>
</div>
<!-- totop end -->

<!-- swiftype search start -->

<!-- swiftype search end -->



<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/lrsjng.jquery-qrcode/0.12.0/jquery.qrcode.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

</div>
</body>
</html>
