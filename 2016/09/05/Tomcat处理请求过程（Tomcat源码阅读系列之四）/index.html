
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  
  <title>Tomcat处理请求过程(Tomcat源码阅读系系列之四) | WoodyOilove&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="在前面的三篇文章中我们分别介绍了搭建Tomcat源码阅读环境、Tomcat的整体架构以及Tomat的启动和关闭过程，接着本文将分析Tomcat处理请求的过程。熟悉Java Socket编程的读者知道，Http的请求处理的一般过程如下：

浏览器发送Http请求

服务器通过Socket读取请求数据

根据Http协议解析数据

调用后台服务完成后响应信息。


下面我们一步步地来看Tomcat是如">
<meta property="og:type" content="article">
<meta property="og:title" content="Tomcat处理请求过程(Tomcat源码阅读系系列之四)">
<meta property="og:url" content="localhost:4000/2016/09/05/Tomcat处理请求过程（Tomcat源码阅读系列之四）/index.html">
<meta property="og:site_name" content="WoodyOilove's Blog">
<meta property="og:description" content="在前面的三篇文章中我们分别介绍了搭建Tomcat源码阅读环境、Tomcat的整体架构以及Tomat的启动和关闭过程，接着本文将分析Tomcat处理请求的过程。熟悉Java Socket编程的读者知道，Http的请求处理的一般过程如下：

浏览器发送Http请求

服务器通过Socket读取请求数据

根据Http协议解析数据

调用后台服务完成后响应信息。


下面我们一步步地来看Tomcat是如">
<meta property="og:updated_time" content="2016-09-05T08:14:59.515Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Tomcat处理请求过程(Tomcat源码阅读系系列之四)">
<meta name="twitter:description" content="在前面的三篇文章中我们分别介绍了搭建Tomcat源码阅读环境、Tomcat的整体架构以及Tomat的启动和关闭过程，接着本文将分析Tomcat处理请求的过程。熟悉Java Socket编程的读者知道，Http的请求处理的一般过程如下：

浏览器发送Http请求

服务器通过Socket读取请求数据

根据Http协议解析数据

调用后台服务完成后响应信息。


下面我们一步步地来看Tomcat是如">
  
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link href="//fonts.useso.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]-->
  
  

</head>

<body>
<div id="container">
  <div id="wrap">
    <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <nav id="upper-nav" class="inner">
      <a id="main-nav-toggle" class="nav-icon"></a>
      <div class="sub-nav">
        
        
          <a id="nav-github" class="nav-icon" href="https://github.com/oilove"></a>
        
      </div>
    </nav>
    <div id="header-title">
      
        <h1 id="blog-title-wrap">
          <a href="/" id="blog-title">WoodyOilove&#39;s Blog</a>
        </h1>
      
    </div>
    <div id="contenedor">
      <ul class="cube">
        <li class="cara">H</li>
        <li class="cara"><svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="100" width="100" viewBox="-50 -50 200 200">
          <circle cx="50" cy="50" r="45" stroke-width="5" stroke="black" stroke-opacity="0.5" fill-opacity="0"></circle>
          <rect x="47.5" y="27.5" width="5" height="25" rx="2.5" ry="2.5" fill="black" fill-opacity="0.5" transform="rotate(330 50 50)"></rect>
          <rect x="48.5" y="16.5" width="3" height="35" rx="1.5" ry="1.5" fill="black" fill-opacity="0.5"></rect>
        </svg></li>
        <li class="cara">F</li>
        <li class="cara">O</li>
        <li class="cara">E</li>
        <li class="cara">N</li>
      </ul>
    </div>
    <nav id="main-nav">
      
        <a class="main-nav-link" href="/">Home</a>
      
        <a class="main-nav-link" href="/archives">Archives</a>
      
        <a class="main-nav-link" href="/about">About</a>
      
      <!--<a class="main-nav-link st-search-show-outputs">Search</a>-->
    </nav>
  </div>
</header>

    <div class="outer">
      <section id="main"><article id="post-Tomcat处理请求过程（Tomcat源码阅读系列之四）" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <h3 href="/2016/09/05/Tomcat处理请求过程（Tomcat源码阅读系列之四）/" class="article-date">
  <time datetime="2016-09-04T16:00:00.000Z" itemprop="datePublished">2016-09-05</time>
</h3>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tomcat/">Tomcat</a>
  </div>

  </div>
  <div class="article-inner">
  <div class="curve-down">
  <div class="fill-content">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Tomcat处理请求过程(Tomcat源码阅读系系列之四)
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
          <div id="toc" class="toc-article">
            <strong class="toc-title">文章目錄</strong>
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#读取请求信息"><span class="toc-text">读取请求信息</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#解析请求数据"><span class="toc-text">解析请求数据</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Adaptor转发请求到Servlet"><span class="toc-text">Adaptor转发请求到Servlet</span></a></li></ol>
          </div>
        
        <p>在前面的三篇文章中我们分别介绍了搭建Tomcat源码阅读环境、Tomcat的整体架构以及Tomat的启动和关闭过程，接着本文将分析Tomcat处理请求的过程。熟悉Java Socket编程的读者知道，Http的请求处理的一般过程如下：</p>
<ol>
<li><p>浏览器发送Http请求</p>
</li>
<li><p>服务器通过Socket读取请求数据</p>
</li>
<li><p>根据Http协议解析数据</p>
</li>
<li><p>调用后台服务完成后响应信息。</p>
</li>
</ol>
<p>下面我们一步步地来看Tomcat是如何实现以上的过程的。</p>
<h1 id="读取请求信息"><a href="#读取请求信息" class="headerlink" title="读取请求信息"></a>读取请求信息</h1><p>从Tomcat的生命周期这篇文章中，我们已经知道Tomcat是在<code>org.apache.tomcat.util.net.JIoEndpoint</code> 的内部类<code>Acceptor</code>线程对请求进行监听的，其代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">Acceptor</span> <span class="keyword">extends</span> <span class="title">AbstractEndpoint</span>.<span class="title">Acceptor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> errorDelay = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="comment">//一直执行知道接收到关闭服务器的命令</span></div><div class="line">    <span class="keyword">while</span> (running) &#123;</div><div class="line"></div><div class="line">        <span class="comment">//默认情况下是执行的，也就是说默认情况下paused是为false</span></div><div class="line">        <span class="keyword">while</span> (paused &amp;&amp; running) &#123;</div><div class="line">            state = AcceptorState.PAUSED;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">               Thread.sleep(<span class="number">50</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">            <span class="comment">// Ignore</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    	<span class="keyword">if</span> (!running) &#123;</div><div class="line">       	  <span class="keyword">break</span>;</div><div class="line">    	&#125;</div><div class="line">    	state = AcceptorState.RUNNING;</div><div class="line"></div><div class="line">    	<span class="keyword">try</span> &#123;</div><div class="line">       	   <span class="comment">//使用limitLatch限制最大连接数</span></div><div class="line">           <span class="comment">//1</span></div><div class="line">       	   countUpOrAwaitConnection();</div><div class="line"></div><div class="line">       	   Socket socket = <span class="keyword">null</span>;</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">             <span class="comment">// 接收到达的http请求，如果没有请求到达会阻塞该线程</span></div><div class="line">             <span class="comment">//2</span></div><div class="line">             socket = serverSocketFactory.acceptSocket(serverSocket);</div><div class="line">           &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</div><div class="line">              countDownConnection();</div><div class="line">              <span class="comment">// Introduce delay if necessary</span></div><div class="line">              errorDelay = handleExceptionWithDelay(errorDelay);</div><div class="line">              <span class="comment">// re-throw</span></div><div class="line">              <span class="keyword">throw</span> ioe;</div><div class="line">           &#125;</div><div class="line">       		<span class="comment">// Successful accept, reset the error delay</span></div><div class="line">      	   errorDelay = <span class="number">0</span>;</div><div class="line"></div><div class="line">       	   <span class="comment">// 设置Socket的配置信息，是否为长连接、发送窗口大小等</span></div><div class="line">           <span class="comment">//3</span></div><div class="line">           <span class="keyword">if</span> (running &amp;&amp; !paused &amp;&amp; setSocketOptions(socket)) &#123;</div><div class="line">             <span class="comment">//提交socket到相对应的processor线程池处理</span></div><div class="line">             <span class="comment">//4</span></div><div class="line">             <span class="keyword">if</span> (!processSocket(socket)) &#123;</div><div class="line">               countDownConnection();</div><div class="line">               <span class="comment">// Close socket right away</span></div><div class="line">               closeSocket(socket);</div><div class="line">             &#125;</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               countDownConnection();</div><div class="line">               <span class="comment">// Close socket right away</span></div><div class="line">               closeSocket(socket);</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (IOException x) &#123;</div><div class="line">            <span class="keyword">if</span> (running) &#123;</div><div class="line">                log.error(sm.getString(<span class="string">"endpoint.accept.fail"</span>), x);</div><div class="line">            &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (NullPointerException npe) &#123;</div><div class="line">            <span class="keyword">if</span> (running) &#123;</div><div class="line">               log.error(sm.getString(<span class="string">"endpoint.accept.fail"</span>), npe);</div><div class="line">            &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">           ExceptionUtils.handleThrowable(t);</div><div class="line">           log.error(sm.getString(<span class="string">"endpoint.accept.fail"</span>), t);</div><div class="line">       &#125;</div><div class="line">    &#125;</div><div class="line">    state = AcceptorState.ENDED;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">processSocket</span><span class="params">(Socket socket)</span> </span>&#123;</div><div class="line">    <span class="comment">// Process the request from this socket</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="comment">//Socket包装类，添加一些socket属性</span></div><div class="line">      SocketWrapper&lt;Socket&gt; wrapper = <span class="keyword">new</span> SocketWrapper&lt;Socket&gt;(socket);</div><div class="line">      wrapper.setKeepAliveLeft(getMaxKeepAliveRequests());</div><div class="line">      <span class="comment">// During shutdown, executor may be null - avoid NPE</span></div><div class="line">      <span class="keyword">if</span> (!running) &#123;</div><div class="line">         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">      &#125;</div><div class="line">      getExecutor().execute(<span class="keyword">new</span> SocketProcessor(wrapper));</div><div class="line">    &#125; <span class="keyword">catch</span> (RejectedExecutionException x) &#123;</div><div class="line">        log.warn(<span class="string">"Socket processing request was rejected for:"</span>+socket,x);</div><div class="line">         <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        ExceptionUtils.handleThrowable(t);</div><div class="line">       <span class="comment">// This means we got an OOM or similar creating a thread, or that</span></div><div class="line">       <span class="comment">// the pool and its queue are full</span></div><div class="line">       log.error(sm.getString(<span class="string">"endpoint.process.fail"</span>), t);</div><div class="line">       <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述代码虽然比较长，但实际上主要做了上面标注的四件事：</p>
<ol>
<li>检查是否已经达到了最大连接数，没有则占用一个连接数</li>
<li>调用ServerSocket的accept()方法接收到达的请求，如果没有请求到达，则阻塞线程</li>
<li>设置Socket的配置参数，如是否为长连接等</li>
<li>提交socket给相应的processor进行处理。</li>
</ol>
<p>接下来我们再来看看Tomcat是如何对Http协议进行解析的，首先我们先来看看<code>SocketProcessor#run</code>方法，其代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">boolean</span> launch = <span class="keyword">false</span>;</div><div class="line">   <span class="keyword">synchronized</span> (socket) &#123;</div><div class="line">     <span class="keyword">try</span> &#123;</div><div class="line">       SocketState state = SocketState.OPEN;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">         <span class="comment">// SSL handshake</span></div><div class="line">         serverSocketFactory.handshake(socket.getSocket());</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            ExceptionUtils.handleThrowable(t);</div><div class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">              log.debug(sm.getString(<span class="string">"endpoint.err.handshake"</span>), t);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// Tell to close the socket</span></div><div class="line">            state = SocketState.CLOSED;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ((state != SocketState.CLOSED)) &#123;</div><div class="line">           <span class="keyword">if</span> (status == <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="comment">//1，处理处理请求</span></div><div class="line">              state = handler.process(socket, SocketStatus.OPEN);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">              state = handler.process(socket,status);</div><div class="line">           &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (state == SocketState.CLOSED) &#123;</div><div class="line">           <span class="comment">// Close socket</span></div><div class="line">           <span class="keyword">if</span> (log.isTraceEnabled()) &#123;</div><div class="line">             log.trace(<span class="string">"Closing socket:"</span>+socket);</div><div class="line">           &#125;</div><div class="line">           countDownConnection();</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               socket.getSocket().close();</div><div class="line">           &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">               <span class="comment">// Ignore</span></div><div class="line">           &#125;</div><div class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.OPEN ||</div><div class="line">                    state == SocketState.UPGRADING  ||</div><div class="line">                    state == SocketState.UPGRADED)&#123;</div><div class="line">                  socket.setKeptAlive(<span class="keyword">true</span>);</div><div class="line">                  socket.access();</div><div class="line">                  launch = <span class="keyword">true</span>;</div><div class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state == SocketState.LONG) &#123;</div><div class="line">                 socket.access();</div><div class="line">                 waitingRequests.add(socket);</div><div class="line">         &#125;</div><div class="line">     &#125; <span class="keyword">finally</span> &#123;</div><div class="line">          <span class="keyword">if</span> (launch) &#123;</div><div class="line">              <span class="keyword">try</span> &#123;</div><div class="line">                getExecutor().execute(<span class="keyword">new</span> SocketProcessor(socket, SocketStatus.OPEN));</div><div class="line">              &#125; <span class="keyword">catch</span> (RejectedExecutionException x) &#123;</div><div class="line">                  log.warn(<span class="string">"Socket reprocessing request was rejected for:"</span>+socket,x);</div><div class="line">                  <span class="keyword">try</span> &#123;</div><div class="line">                    <span class="comment">//unable to handle connection at this time</span></div><div class="line">                    handler.process(socket, SocketStatus.DISCONNECT);</div><div class="line">                  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                     countDownConnection();</div><div class="line">                  &#125;</div><div class="line">               &#125; <span class="keyword">catch</span> (NullPointerException npe) &#123;</div><div class="line">                    <span class="keyword">if</span> (running) &#123;</div><div class="line">                      log.error(sm.getString(<span class="string">"endpoint.launch.fail"</span>),npe);</div><div class="line">                    &#125;</div><div class="line">               &#125;</div><div class="line">          &#125;</div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line">   socket = <span class="keyword">null</span>;</div><div class="line">   <span class="comment">// Finish up this request</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述代码核心的标注1的代码，调用handler的process方法处理socket，我们继续debug进去发现，调用了<code>AbstractProtocol$Http11ConnectionHandler#process</code>方法，最终调用<code>Http11Processor#process</code>方法对socket进行处理，因此下面我们来看看<code>Http11Processor#process</code>方法，其代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> SocketState <span class="title">process</span><span class="params">(SocketWrapper&lt;S&gt; socketWrapper)</span></span></div><div class="line">    <span class="keyword">throws</span> IOException &#123;</div><div class="line">    RequestInfo rp = request.getRequestProcessor();</div><div class="line">    rp.setStage(org.apache.coyote.Constants.STAGE_PARSE);</div><div class="line"></div><div class="line">    <span class="comment">// Setting up the I/O</span></div><div class="line">    setSocketWrapper(socketWrapper);</div><div class="line">    getInputBuffer().init(socketWrapper, endpoint);</div><div class="line">    getOutputBuffer().init(socketWrapper, endpoint);</div><div class="line"></div><div class="line">    <span class="comment">// Flags</span></div><div class="line">    error = <span class="keyword">false</span>;</div><div class="line">    keepAlive = <span class="keyword">true</span>;</div><div class="line">    comet = <span class="keyword">false</span>;</div><div class="line">    openSocket = <span class="keyword">false</span>;</div><div class="line">    sendfileInProgress = <span class="keyword">false</span>;</div><div class="line">    readComplete = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">if</span> (endpoint.getUsePolling()) &#123;</div><div class="line">        keptAlive = <span class="keyword">false</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        keptAlive = socketWrapper.isKeptAlive();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (disableKeepAlive()) &#123;</div><div class="line">        socketWrapper.setKeepAliveLeft(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (!error &amp;&amp; keepAlive &amp;&amp; !comet &amp;&amp; !isAsync() &amp;&amp;</div><div class="line">            upgradeInbound == <span class="keyword">null</span> &amp;&amp; !endpoint.isPaused()) &#123;</div><div class="line"></div><div class="line">        <span class="comment">//1解析请求头</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            setRequestLineReadTimeout();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!getInputBuffer().parseRequestLine(keptAlive)) &#123;</div><div class="line">                <span class="keyword">if</span> (handleIncompleteRequestLineRead()) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (endpoint.isPaused()) &#123;</div><div class="line">                <span class="comment">// 503 - Service unavailable</span></div><div class="line">                response.setStatus(<span class="number">503</span>);</div><div class="line">                error = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Make sure that connectors that are non-blocking during</span></div><div class="line">                <span class="comment">// header processing (NIO) only set the start time the first</span></div><div class="line">                <span class="comment">// time a request is processed.</span></div><div class="line">                <span class="keyword">if</span> (request.getStartTime() &lt; <span class="number">0</span>) &#123;</div><div class="line">                    request.setStartTime(System.currentTimeMillis());</div><div class="line">                &#125;</div><div class="line">                keptAlive = <span class="keyword">true</span>;</div><div class="line">                <span class="comment">// Set this every time in case limit has been changed via JMX</span></div><div class="line">                request.getMimeHeaders().setLimit(endpoint.getMaxHeaderCount());</div><div class="line">                <span class="comment">// Currently only NIO will ever return false here</span></div><div class="line">                <span class="keyword">if</span> (!getInputBuffer().parseHeaders()) &#123;</div><div class="line">                    <span class="comment">// We've read part of the request, don't recycle it</span></div><div class="line">                    <span class="comment">// instead associate it with the socket</span></div><div class="line">                    openSocket = <span class="keyword">true</span>;</div><div class="line">                    readComplete = <span class="keyword">false</span>;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (!disableUploadTimeout) &#123;</div><div class="line">                    setSocketTimeout(connectionUploadTimeout);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</div><div class="line">                getLog().debug(</div><div class="line">                    sm.getString(<span class="string">"http11processor.header.parse"</span>), e);</div><div class="line">            &#125;</div><div class="line">            error = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            ExceptionUtils.handleThrowable(t);</div><div class="line">            UserDataHelper.Mode logMode = userDataHelper.getNextMode();                <span class="keyword">if</span> (logMode != <span class="keyword">null</span>) &#123;</div><div class="line">                String message = sm.getString(</div><div class="line">                        <span class="string">"http11processor.header.parse"</span>);</div><div class="line">                <span class="keyword">switch</span> (logMode) &#123;</div><div class="line">                    <span class="keyword">case</span> INFO_THEN_DEBUG:</div><div class="line">                        message += sm.getString(</div><div class="line">                                <span class="string">"http11processor.fallToDebug"</span>);</div><div class="line">                        <span class="comment">//$FALL-THROUGH$</span></div><div class="line">                    <span class="keyword">case</span> INFO:</div><div class="line">                        getLog().info(message);</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="keyword">case</span> DEBUG:</div><div class="line">                        getLog().debug(message);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 400 - Bad Request</span></div><div class="line">            response.setStatus(<span class="number">400</span>);</div><div class="line">            adapter.log(request, response, <span class="number">0</span>);</div><div class="line">            error = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!error) &#123;</div><div class="line">            <span class="comment">// Setting up filters, and parse some request headers</span></div><div class="line">            rp.setStage(org.apache.coyote.Constants.STAGE_PREPARE);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="comment">//2设置filter，请求信息编码</span></div><div class="line">                prepareRequest();</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                ExceptionUtils.handleThrowable(t);</div><div class="line">                <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</div><div class="line">                    getLog().debug(sm.getString(</div><div class="line">                        <span class="string">"http11processor.request.prepare"</span>), t);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// 400 - Internal Server Error</span></div><div class="line">                response.setStatus(<span class="number">400</span>);</div><div class="line">                adapter.log(request, response, <span class="number">0</span>);</div><div class="line">                error = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (maxKeepAliveRequests == <span class="number">1</span>) &#123;</div><div class="line">            keepAlive = <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (maxKeepAliveRequests &gt; <span class="number">0</span> &amp;&amp;</div><div class="line">            socketWrapper.decrementKeepAlive() &lt;= <span class="number">0</span>) &#123;</div><div class="line">            keepAlive = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//3 adaptor调用相应的Servlet处理请求</span></div><div class="line">        <span class="keyword">if</span> (!error) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                rp.setStage(org.apache.coyote.Constants.STAGE_SERVICE);</div><div class="line">                adapter.service(request, response);</div><div class="line">                <span class="comment">// Handle when the response was committed before a serious</span></div><div class="line">                <span class="comment">// error occurred.  Throwing a ServletException should both</span></div><div class="line">                <span class="comment">// set the status to 500 and set the errorException.</span></div><div class="line">                <span class="comment">// If we fail here, then the response is likely already</span></div><div class="line">                <span class="comment">// committed, so we can't try and set headers.</span></div><div class="line">                <span class="keyword">if</span>(keepAlive &amp;&amp; !error) &#123; <span class="comment">// Avoid checking twice.</span></div><div class="line">                    error = response.getErrorException() != <span class="keyword">null</span> ||</div><div class="line">                        (!isAsync() &amp;&amp;</div><div class="line">                        statusDropsConnection(response.getStatus()));</div><div class="line">                &#125;</div><div class="line">                setCometTimeouts(socketWrapper);</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedIOException e) &#123;</div><div class="line">                error = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (HeadersTooLargeException e) &#123;</div><div class="line">                error = <span class="keyword">true</span>;</div><div class="line">                <span class="comment">// The response should not have been committed but check it</span></div><div class="line">                <span class="comment">// anyway to be safe</span></div><div class="line">                <span class="keyword">if</span> (!response.isCommitted()) &#123;</div><div class="line">                    response.reset();</div><div class="line">                    response.setStatus(<span class="number">500</span>);</div><div class="line">                    response.setHeader(<span class="string">"Connection"</span>, <span class="string">"close"</span>);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                ExceptionUtils.handleThrowable(t);</div><div class="line">                getLog().error(sm.getString(</div><div class="line">                        <span class="string">"http11processor.request.process"</span>), t);</div><div class="line">                <span class="comment">// 500 - Internal Server Error</span></div><div class="line">                response.setStatus(<span class="number">500</span>);</div><div class="line">                adapter.log(request, response, <span class="number">0</span>);</div><div class="line">                error = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//4 完成请求后，响应请求等处理</span></div><div class="line">        rp.setStage(org.apache.coyote.Constants.STAGE_ENDINPUT);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!isAsync() &amp;&amp; !comet) &#123;</div><div class="line">            <span class="keyword">if</span> (error) &#123;</div><div class="line">                <span class="comment">// If we know we are closing the connection, don't drain</span></div><div class="line">                <span class="comment">// input. This way uploading a 100GB file doesn't tie up the</span></div><div class="line">                <span class="comment">// thread if the servlet has rejected it.</span></div><div class="line">                getInputBuffer().setSwallowInput(<span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">            endRequest();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        rp.setStage(org.apache.coyote.Constants.STAGE_ENDOUTPUT);</div><div class="line"></div><div class="line">        <span class="comment">// If there was an error, make sure the request is counted as</span></div><div class="line">        <span class="comment">// and error, and update the statistics counter</span></div><div class="line">        <span class="keyword">if</span> (error) &#123;</div><div class="line">            response.setStatus(<span class="number">500</span>);</div><div class="line">        &#125;</div><div class="line">        request.updateCounters();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!isAsync() &amp;&amp; !comet || error) &#123;</div><div class="line">            getInputBuffer().nextRequest();</div><div class="line">            getOutputBuffer().nextRequest();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!disableUploadTimeout) &#123;</div><div class="line">            <span class="keyword">if</span>(endpoint.getSoTimeout() &gt; <span class="number">0</span>) &#123;</div><div class="line">                setSocketTimeout(endpoint.getSoTimeout());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                setSocketTimeout(<span class="number">0</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        rp.setStage(org.apache.coyote.Constants.STAGE_KEEPALIVE);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (breakKeepAliveLoop(socketWrapper)) &#123;</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    rp.setStage(org.apache.coyote.Constants.STAGE_ENDED);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (error || endpoint.isPaused()) &#123;</div><div class="line">        <span class="keyword">return</span> SocketState.CLOSED;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isAsync() || comet) &#123;</div><div class="line">           <span class="keyword">return</span> SocketState.LONG;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isUpgrade()) &#123;</div><div class="line">            <span class="keyword">return</span> SocketState.UPGRADING;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (sendfileInProgress) &#123;</div><div class="line">            <span class="keyword">return</span> SocketState.SENDFILE;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (openSocket) &#123;</div><div class="line">                <span class="keyword">if</span> (readComplete) &#123;</div><div class="line">                    <span class="keyword">return</span> SocketState.OPEN;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">return</span> SocketState.LONG;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">return</span> SocketState.CLOSED;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码比较长，但实际上该方法主要做了四件事：</p>
<ol>
<li>解析请求头信息</li>
<li>调用<code>prepareRequest</code> 方法在处理请求之前对请求做一些处理，如Filter、设置编码等，</li>
<li>调用adaptor调用对应的Servlet处理请求</li>
<li>调用<code>endrequest</code> 在完成请求后的相关处理，如响应信息等</li>
</ol>
<p>前两步的作用是从Socket中获取信息构建<code>org.apache.coyote.Request</code>和<code>org.apache.coyote.Response</code> </p>
<p>下面我们来看看Tomcat是如何解析请求信息的。</p>
<h1 id="解析请求数据"><a href="#解析请求数据" class="headerlink" title="解析请求数据"></a>解析请求数据</h1><p>从上面我们已经知道Tomcat的解析请求数据的代码就如下几句：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//设置读取请求行超时时间</span></div><div class="line">setRequestLineReadTimeout();</div><div class="line"><span class="comment">//1解析请求行</span></div><div class="line"><span class="keyword">if</span> (!getInputBuffer().parseRequestLine(keptAlive)) &#123;</div><div class="line">   <span class="keyword">if</span> (handleIncompleteRequestLineRead()) &#123;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (endpoint.isPaused()) &#123;</div><div class="line">   <span class="comment">// 503 - Service unavailable</span></div><div class="line">   response.setStatus(<span class="number">503</span>);</div><div class="line">   error = <span class="keyword">true</span>;</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">   <span class="comment">// Make sure that connectors that are non-blocking during</span></div><div class="line">   <span class="comment">// header processing (NIO) only set the start time the first</span></div><div class="line">   <span class="comment">// time a request is processed.</span></div><div class="line">   <span class="keyword">if</span> (request.getStartTime() &lt; <span class="number">0</span>) &#123;</div><div class="line">      request.setStartTime(System.currentTimeMillis());</div><div class="line">   &#125;</div><div class="line">   keptAlive = <span class="keyword">true</span>;</div><div class="line">   <span class="comment">// Set this every time in case limit has been changed via JMX</span></div><div class="line">   request.getMimeHeaders().setLimit(endpoint.getMaxHeaderCount());</div><div class="line">  <span class="comment">// Currently only NIO will ever return false here</span></div><div class="line">   <span class="comment">//2 处理请求头</span></div><div class="line">   <span class="keyword">if</span> (!getInputBuffer().parseHeaders()) &#123;</div><div class="line">         <span class="comment">// We've read part of the request, don't recycle it</span></div><div class="line">         <span class="comment">// instead associate it with the socket</span></div><div class="line">         openSocket = <span class="keyword">true</span>;</div><div class="line">         readComplete = <span class="keyword">false</span>;</div><div class="line">         <span class="keyword">break</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">if</span> (!disableUploadTimeout) &#123;</div><div class="line">      setSocketTimeout(connectionUploadTimeout);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上面的代码我们可以知道首先先解析请求行，再解析请求头的信息，请求头的信息存放在<code>MimeHeaders</code>中。到了这了有必要说明一下，请求行和请求体。我们来看下面的例子：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">GET / HTTP/1.1</div><div class="line">Accept:text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</div><div class="line">Accept-Encoding:gzip, deflate, sdch</div><div class="line">Accept-Language:zh-CN,zh;q=0.8</div><div class="line">Cache-Control:max-age=0</div><div class="line">Connection:keep-alive</div><div class="line">DNT:1</div><div class="line">Host:localhost:8080</div><div class="line">Upgrade-Insecure-Requests:1</div><div class="line">User-Agent:Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.75 Safari/537.36</div></pre></td></tr></table></figure>
<p>在上面的Http协议get请求中，第一行就是请求行，其余的都是请求体，但需要注意的是HTTP协议的要求，请求行末尾必须是CRLF，而请求行与请求体之间必须使用空行隔开，而空行也必须包含CRLF。至于<code>parseRequestLine</code> 和 <code>parseHeaders</code>方法的分析，在此不作分析，有兴趣的可以自行阅读代码分析，需要注意其中了CR和LF的判断体现刚刚所说的HTTP协议的要求。接下来我们来看看adaptor是如何将请求转发的对应的Servlet的。</p>
<h1 id="Adaptor转发请求到Servlet"><a href="#Adaptor转发请求到Servlet" class="headerlink" title="Adaptor转发请求到Servlet"></a>Adaptor转发请求到Servlet</h1><p>在上面我们已经知道如何根据HTTP协议在Socket中解析出信息，并构建<code>org.apache.Request</code> 和 <code>org.apache.Response</code> 对象，通过Adaptor调用相应Servlet进行具体的处理，下面我们来看<code>CoyoteAdaptor#service</code>方法，其代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(org.apache.coyote.Request req,</span></span></div><div class="line">                        org.apache.coyote.Response res)</div><div class="line">    <span class="keyword">throws</span> Exception &#123;</div><div class="line">    </div><div class="line">    Request request = (Request) req.getNote(ADAPTER_NOTES);</div><div class="line">    Response response = (Response) res.getNote(ADAPTER_NOTES);</div><div class="line">	<span class="comment">//1，将org.apache.coyote.Request和org.apache.coyote.Response对象装换为org.apache.catalina.connector.Request和org.apache.catalina.connector.Response对象</span></div><div class="line">    <span class="keyword">if</span> (request == <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Create objects</span></div><div class="line">        request = connector.createRequest();</div><div class="line">        request.setCoyoteRequest(req);</div><div class="line">        response = connector.createResponse();</div><div class="line">        response.setCoyoteResponse(res);</div><div class="line"></div><div class="line">        <span class="comment">// Link objects</span></div><div class="line">        request.setResponse(response);</div><div class="line">        response.setRequest(request);</div><div class="line"></div><div class="line">        <span class="comment">// Set as notes</span></div><div class="line">        req.setNote(ADAPTER_NOTES, request);</div><div class="line">        res.setNote(ADAPTER_NOTES, response);</div><div class="line"></div><div class="line">        <span class="comment">// Set query string encoding</span></div><div class="line">        req.getParameters().setQueryStringEncoding</div><div class="line">            (connector.getURIEncoding());</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (connector.getXpoweredBy()) &#123;</div><div class="line">        response.addHeader(<span class="string">"X-Powered-By"</span>, POWERED_BY);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> comet = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">boolean</span> async = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">        <span class="comment">// Parse and set Catalina and configuration specific</span></div><div class="line">        <span class="comment">// request parameters</span></div><div class="line">        req.getRequestProcessor().setWorkerThreadName(Thread.currentThread().getName());</div><div class="line">        <span class="comment">//2 根据request和找到对应的Host、Context、和Wrapper对象，即找到对应的Servlet</span></div><div class="line">        <span class="keyword">boolean</span> postParseSuccess = postParseRequest(req, request, res, response);</div><div class="line">        <span class="keyword">if</span> (postParseSuccess) &#123;</div><div class="line">            <span class="comment">//check valves if we support async</span></div><div class="line">            request.setAsyncSupported(connector.getService().getContainer().getPipeline().isAsyncSupported());</div><div class="line">            <span class="comment">//3 调用相应的容器进行处理</span></div><div class="line">            connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (request.isComet()) &#123;</div><div class="line">                <span class="keyword">if</span> (!response.isClosed() &amp;&amp; !response.isError()) &#123;</div><div class="line">                    <span class="keyword">if</span> (request.getAvailable() || (request.getContentLength() &gt; <span class="number">0</span> &amp;&amp; (!request.isParametersParsed()))) &#123;</div><div class="line">                        <span class="comment">// Invoke a read event right away if there are available bytes</span></div><div class="line">                        <span class="keyword">if</span> (event(req, res, SocketStatus.OPEN)) &#123;</div><div class="line">                            comet = <span class="keyword">true</span>;</div><div class="line">                            res.action(ActionCode.COMET_BEGIN, <span class="keyword">null</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        comet = <span class="keyword">true</span>;</div><div class="line">                        res.action(ActionCode.COMET_BEGIN, <span class="keyword">null</span>);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// Clear the filter chain, as otherwise it will not be reset elsewhere</span></div><div class="line">                    <span class="comment">// since this is a Comet request</span></div><div class="line">                    request.setFilterChain(<span class="keyword">null</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        AsyncContextImpl asyncConImpl = (AsyncContextImpl)request.getAsyncContext();</div><div class="line">        <span class="keyword">if</span> (asyncConImpl != <span class="keyword">null</span>) &#123;</div><div class="line">            async = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!comet) &#123;</div><div class="line">            request.finishRequest();</div><div class="line">            response.finishResponse();</div><div class="line">            <span class="keyword">if</span> (postParseSuccess &amp;&amp;</div><div class="line">                request.getMappingData().context != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// Log only if processing was invoked.</span></div><div class="line">                <span class="comment">// If postParseRequest() failed, it has already logged it.</span></div><div class="line">                <span class="comment">// If context is null this was the start of a comet request</span></div><div class="line">                <span class="comment">// that failed and has already been logged.</span></div><div class="line">                ((Context) request.getMappingData().context).logAccess(</div><div class="line">                        request, response,</div><div class="line">                        System.currentTimeMillis() - req.getStartTime(),</div><div class="line">                        <span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">            req.action(ActionCode.POST_REQUEST , <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">        <span class="comment">// Ignore</span></div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        req.getRequestProcessor().setWorkerThreadName(<span class="keyword">null</span>);</div><div class="line">        <span class="comment">// Recycle the wrapper request and response</span></div><div class="line">        <span class="keyword">if</span> (!comet &amp;&amp; !async) &#123;</div><div class="line">            request.recycle();</div><div class="line">            response.recycle();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">// Clear converters so that the minimum amount of memory</span></div><div class="line">            <span class="comment">// is used by this processor</span></div><div class="line">            request.clearEncoders();</div><div class="line">            response.clearEncoders();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码比较长，笔者标注了主流程的代码，下面我们逐一分析标注的代码：</p>
<ol>
<li>标注1的代码是将<code>org.apache.coyote.Request</code>和<code>org.apache.coyote.Response</code>对象装换为<code>org.apache.catalina.connector.Request</code>和<code>org.apache.catalina.connector.Response</code>对象,其中coyote包中的Request仅仅只是包含了解析出来的http协议的数据，而connector包中的Reqeust才是真正Servlet容器中的HttpservletRequest，里面包含了完成请求所需要的host、context和wrapper信息。</li>
<li>标注2调用<code>postParseRequest</code>方法，这个方法做了很多事，但主要都是为了根据request找到对应的Host、Context和Wrapper对象，换句话说就是找到处理请求的Servlet。</li>
<li>标注3的代码将Request通过Pipeline机制链式传递给最终的Servlet进行处理。</li>
</ol>
<p>至此我们已经从整体上理解了<code>org.apache.connector.CoyoteAdaptor#service</code> 方法的主要步骤，接下来我们来具体分析每一步所做的事，第一步比较简单，大家可以自行进行阅读，在此不作说明，主要来看看第2、3步。</p>
<p>首先我们来看看第2步，即<code>postParseRequest</code> 方法，其代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">postParseRequest</span><span class="params">(org.apache.coyote.Request req,</span></span></div><div class="line">                                       Request request,</div><div class="line">                                       org.apache.coyote.Response res,</div><div class="line">                                       Response response)</div><div class="line">            <span class="keyword">throws</span> Exception &#123;</div><div class="line"></div><div class="line">    <span class="comment">//省略了请求相关的参数的处理，为了下面查找对应的Context</span></div><div class="line"></div><div class="line">    <span class="keyword">while</span> (mapRequired) &#123;</div><div class="line">        <span class="keyword">if</span> (version != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// Once we have a version - that is it</span></div><div class="line">            mapRequired = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// 根据serverName和decodeURI查找对应的Context，和Wapper</span></div><div class="line">        connector.getMapper().map(serverName, decodedURI, version,</div><div class="line">                                    request.getMappingData());</div><div class="line">       <span class="comment">//获取context</span></div><div class="line">        request.setContext((Context) request.getMappingData().context);</div><div class="line">       <span class="comment">//获取Wrapper</span></div><div class="line">        request.setWrapper((Wrapper) request.getMappingData().wrapper);</div><div class="line"></div><div class="line">        <span class="comment">//此处省略了session等处理的代码</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//省略了转发处理，filter方法处理的代码</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们通过进一步分析查看<code>connector.getMapper.map</code>方法，知道该方法最终是在Mapper中有序的<code>map</code>元素数组中查找相应的Context和Wrapper，并保存到<code>org.apache.tomcat.util.http.mapper.MappingData</code>类型的属性中，执行完map方法后，再从MappingData中获取Context和Wrapper。</p>
<p>接着我们来分析第3步，这一步通过pipeline链式调用机制，最终调用了Servlet对象，而对于pipeline，其实是运用了责任链设计模式，它将各个阀门链接起来，然后一步步调用。阀门的主要来源有以下两个：</p>
<ol>
<li><code>conf/server.xml</code>文件中配置的<code>Value</code></li>
<li>每个容器的构造器中初始化的自己阀门,即每个容器都有一个对应的阀门对象，如<code>StandardEngine</code> 对应<code>StandardEngineValue</code>。</li>
</ol>
<p>通过debug跟踪代码，我们可以得到如下一个调用链：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">StandardEngineValue#invoke</div><div class="line">-&gt;AccessLogValue#invoke</div><div class="line">--&gt;ErrorReportValue#invoke</div><div class="line">---&gt;StandardHostValue#invoke</div><div class="line">----&gt;StandardContextValue#invoke</div><div class="line">-----&gt;StandardWrapperValue#invoke</div></pre></td></tr></table></figure>
<p>从上面我们知道最终调用<code>StandardWrapperValue#invoke</code> 方法，我们来看看<code>StandardWrapperValue#invoke</code> 方法，其代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></div><div class="line">       <span class="keyword">throws</span> IOException, ServletException &#123;</div><div class="line"></div><div class="line">       <span class="comment">// Initialize local variables we may need</span></div><div class="line">       <span class="keyword">boolean</span> unavailable = <span class="keyword">false</span>;</div><div class="line">       Throwable throwable = <span class="keyword">null</span>;</div><div class="line">       <span class="comment">// This should be a Request attribute...</span></div><div class="line">       <span class="keyword">long</span> t1=System.currentTimeMillis();</div><div class="line">       requestCount++;</div><div class="line">       StandardWrapper wrapper = (StandardWrapper) getContainer();</div><div class="line">       Servlet servlet = <span class="keyword">null</span>;</div><div class="line">       Context context = (Context) wrapper.getParent();</div><div class="line">       </div><div class="line">       <span class="comment">// 检查应用是否被标记为不可用</span></div><div class="line">       <span class="keyword">if</span> (!context.getState().isAvailable()) &#123;</div><div class="line">           response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE,</div><div class="line">                          sm.getString(<span class="string">"standardContext.isUnavailable"</span>));</div><div class="line">           unavailable = <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// 检查Servelt是否标记为不可用</span></div><div class="line">       <span class="keyword">if</span> (!unavailable &amp;&amp; wrapper.isUnavailable()) &#123;</div><div class="line">           container.getLogger().info(sm.getString(<span class="string">"standardWrapper.isUnavailable"</span>,</div><div class="line">                   wrapper.getName()));</div><div class="line">           <span class="keyword">long</span> available = wrapper.getAvailable();</div><div class="line">           <span class="keyword">if</span> ((available &gt; <span class="number">0L</span>) &amp;&amp; (available &lt; Long.MAX_VALUE)) &#123;</div><div class="line">               response.setDateHeader(<span class="string">"Retry-After"</span>, available);</div><div class="line">               response.sendError(HttpServletResponse.SC_SERVICE_UNAVAILABLE,</div><div class="line">                       sm.getString(<span class="string">"standardWrapper.isUnavailable"</span>,</div><div class="line">                               wrapper.getName()));</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (available == Long.MAX_VALUE) &#123;</div><div class="line">               response.sendError(HttpServletResponse.SC_NOT_FOUND,</div><div class="line">                       sm.getString(<span class="string">"standardWrapper.notFound"</span>,</div><div class="line">                               wrapper.getName()));</div><div class="line">           &#125;</div><div class="line">           unavailable = <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//1 产生一个Servelt实例处理请求</span></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="keyword">if</span> (!unavailable) &#123;</div><div class="line">               servlet = wrapper.allocate();</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (UnavailableException e) &#123;</div><div class="line">           <span class="comment">//省略异常处理代码</span></div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// Identify if the request is Comet related now that the servlet has been allocated</span></div><div class="line">       <span class="keyword">boolean</span> comet = <span class="keyword">false</span>;</div><div class="line">       <span class="keyword">if</span> (servlet <span class="keyword">instanceof</span> CometProcessor &amp;&amp; request.getAttribute(</div><div class="line">               Globals.COMET_SUPPORTED_ATTR) == Boolean.TRUE) &#123;</div><div class="line">           comet = <span class="keyword">true</span>;</div><div class="line">           request.setComet(<span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">       </div><div class="line">       MessageBytes requestPathMB = request.getRequestPathMB();</div><div class="line">       DispatcherType dispatcherType = DispatcherType.REQUEST;</div><div class="line">       <span class="keyword">if</span> (request.getDispatcherType()==DispatcherType.ASYNC) dispatcherType = DispatcherType.ASYNC; </div><div class="line">       request.setAttribute(Globals.DISPATCHER_TYPE_ATTR,dispatcherType);</div><div class="line">       request.setAttribute(Globals.DISPATCHER_REQUEST_PATH_ATTR,</div><div class="line">               requestPathMB);</div><div class="line">       <span class="comment">// 创建了过滤器filter链</span></div><div class="line">       ApplicationFilterFactory factory =</div><div class="line">           ApplicationFilterFactory.getInstance();</div><div class="line">       ApplicationFilterChain filterChain =</div><div class="line">           factory.createFilterChain(request, wrapper, servlet);</div><div class="line">       </div><div class="line">       <span class="comment">// Reset comet flag value after creating the filter chain</span></div><div class="line">       request.setComet(<span class="keyword">false</span>);</div><div class="line">       <span class="comment">//2 调用filter链</span></div><div class="line">       <span class="comment">// <span class="doctag">NOTE:</span> This also calls the servlet's service() method</span></div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="keyword">if</span> ((servlet != <span class="keyword">null</span>) &amp;&amp; (filterChain != <span class="keyword">null</span>)) &#123;</div><div class="line">               <span class="comment">// Swallow output if needed</span></div><div class="line">               <span class="keyword">if</span> (context.getSwallowOutput()) &#123;</div><div class="line">                   <span class="keyword">try</span> &#123;</div><div class="line">                       SystemLogHandler.startCapture();</div><div class="line">                       <span class="keyword">if</span> (request.isAsyncDispatching()) &#123;</div><div class="line">                           <span class="comment">//TODO SERVLET3 - async</span></div><div class="line">                           ((AsyncContextImpl)request.getAsyncContext()).doInternalDispatch(); </div><div class="line">                       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (comet) &#123;</div><div class="line">                           filterChain.doFilterEvent(request.getEvent());</div><div class="line">                           request.setComet(<span class="keyword">true</span>);</div><div class="line">                       &#125; <span class="keyword">else</span> &#123;</div><div class="line">                           filterChain.doFilter(request.getRequest(), </div><div class="line">                                   response.getResponse());</div><div class="line">                       &#125;</div><div class="line">                   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                       String log = SystemLogHandler.stopCapture();</div><div class="line">                       <span class="keyword">if</span> (log != <span class="keyword">null</span> &amp;&amp; log.length() &gt; <span class="number">0</span>) &#123;</div><div class="line">                           context.getLogger().info(log);</div><div class="line">                       &#125;</div><div class="line">                   &#125;</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   <span class="keyword">if</span> (request.isAsyncDispatching()) &#123;</div><div class="line">                       <span class="comment">//TODO SERVLET3 - async</span></div><div class="line">                       ((AsyncContextImpl)request.getAsyncContext()).doInternalDispatch();</div><div class="line">                   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (comet) &#123;</div><div class="line">                       request.setComet(<span class="keyword">true</span>);</div><div class="line">                       filterChain.doFilterEvent(request.getEvent());</div><div class="line">                   &#125; <span class="keyword">else</span> &#123;</div><div class="line">                       filterChain.doFilter</div><div class="line">                           (request.getRequest(), response.getResponse());</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (ClientAbortException e) &#123;</div><div class="line">           <span class="comment">//省略异常处理代码</span></div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">//省略释放servlet实例和FilterChain代码</span></div><div class="line"></div><div class="line"></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>我们来分析一个上面标注的地方：</p>
<ol>
<li>标注1的代码实例化了Servlet对象，在实例化的过程中使用了Java双检查锁的机制来实现单实例</li>
<li>标注2的代码调用了Servlet的过滤器链，首先在根据filterConfig取到的web.xml文件中配置的filter，一个个调用，最终调用Servlet的service方法。</li>
</ol>
<p>经过上面的分析我们已经基本了解Tomcat请求解析的流程，现总结如下：</p>
<blockquote>
<p>Tomcat通过acceptor线程监听到到达的Http请求后，对socket进行了包装成<code>SocketProcessor</code>，提交给线程池进行处理，而<code>SocketProcessor#run</code> 最终调用了<code>Http11Processor#process</code>方法对socket进行以下处理：</p>
<ol>
<li>解析请求行和请求头的信息</li>
<li>调用prepareRequest 方法在处理请求之前对请求做一些处理，如Filter、请求编码处理等，</li>
<li>通过adaptor调用对应的Servlet处理请求，其调用过程如下：<ol>
<li>首先根据请求的URI和ServerName，从<code>Connector.Mapper</code> 的有序map数组中获取Context和Wrapper并保存到<code>org.apache.tomcat.util.http.mapper.MappingData</code>类型的属性中,接着再从<code>MappingData</code> 中获取Context和Wrapper</li>
<li>通过<code>pipeline</code> 调用机制，从<code>StandardEngineValue#invoke</code>开始，最终调用<code>StandardWrapperValue#invoke</code>，即调用对应的Servlet</li>
<li><code>StandardWrapperValue#invoke</code> 方法会使用Java双检查锁机制创建 <code>Servlet</code> 实例，然后创建<code>FilterChain</code>，调用 <code>FilterChain</code> 的<code>doFilter</code>，并在该方法中调用<code>Servlet</code>的 <code>service</code> 方法</li>
</ol>
</li>
<li>调用endrequest 在完成请求后的相关处理。</li>
</ol>
</blockquote>
<p>[^注：]: 本博客只是笔者对于Tomcat请求处理分析的过程，可能存在错误，欢迎留言或者Email指出，Email地址: woodyoilovecn@gmail.com,同时对于请求处理过程的一些过程并没有进行深入地挖掘，有兴趣的也可以Email一起交流讨论。</p>

      
    </div>
    <footer class="article-footer">
      <div class="article-footer-content">
        
        <a data-url="localhost:4000/2016/09/05/Tomcat处理请求过程（Tomcat源码阅读系列之四）/" data-id="cit3wbfn3000cnworsg6wnzkb" class="article-share-link">分享到</a>
        
          <a href="localhost:4000/2016/09/05/Tomcat处理请求过程（Tomcat源码阅读系列之四）/#ds-thread" class="article-comment-link">評論</a>
        
        
          <span id=""class="leancloud_visitors"  data-flag-title="Tomcat处理请求过程(Tomcat源码阅读系系列之四)">
            &nbsp; | &nbsp; 
            </span>
        
      </div>
    </footer>
  </div>
  </div>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/09/07/设计模式系列之单例模式/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">
        
          设计模式系列之单例模式
        
      </div>
    </a>
  
  
    <a href="/2016/09/05/Tomcat的Session管理（Tomcat源码阅读系列之五）/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">Tomcat的Session管理</div>
    </a>
  
</nav>

  
</article>


  <section id="comments">
    <div id="ds-thread" class="ds-thread" data-thread-key="2016/09/05/Tomcat处理请求过程（Tomcat源码阅读系列之四）/" data-title="Tomcat处理请求过程(Tomcat源码阅读系系列之四)" data-url="localhost:4000/2016/09/05/Tomcat处理请求过程（Tomcat源码阅读系列之四）/"></div>
  </section>


</section>
      
      <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">近期文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/09/07/设计模式系列之学习设计模式之由/">(no title)</a>
          </li>
        
          <li>
            <a href="/2016/09/07/设计模式系列之单例模式/">设计模式系列之单例模式</a>
          </li>
        
          <li>
            <a href="/2016/09/05/Tomcat处理请求过程（Tomcat源码阅读系列之四）/">Tomcat处理请求过程(Tomcat源码阅读系系列之四)</a>
          </li>
        
          <li>
            <a href="/2016/09/05/Tomcat的Session管理（Tomcat源码阅读系列之五）/">Tomcat的Session管理</a>
          </li>
        
          <li>
            <a href="/2016/08/27/eclipse&Myeclipse&Intellij Idea源码阅读快捷键/">eclipse&amp;Myeclipse&amp;Intellij Idea源码阅读快捷键</a>
          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分類</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java框架/">Java框架</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat/">Tomcat</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/开发工具/">开发工具</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机网络/">计算机网络</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">歸檔</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">10</span></li></ul>
    </div>
  </div>

  
</aside>
      
    </div>
    <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 WoodyOilove<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
      .
      Theme by <a href="https://github.com/sun11/hexo-theme-paperbox" target="_blank">Paperbox</a>
    </div>
    
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1260393587'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1260393587%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script>

  </div>
</footer>
  </div>
  <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
  <a href="#search" class="mobile-nav-link st-search-show-outputs">Search</a>
</nav>
  

<!-- totop start -->
<div id="totop">
	<a title="返回頂部"></a>
</div>
<!-- totop end -->

<!-- swiftype search start -->

<!-- swiftype search end -->


<!-- duoshuo start -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"woodyoilove"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>
<!-- duoshuo end -->


<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/lrsjng.jquery-qrcode/0.12.0/jquery.qrcode.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

</div>
</body>
</html>
